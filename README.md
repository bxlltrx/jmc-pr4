# Практическая работа №4  
## Java Message Service (JMS)

## Цель работы
Целью данной практической работы является расширение существующего REST-приложения
механизмом журналирования изменений и системой оповещений на основе технологии
Java Message Service (JMS).

В ходе работы реализуется:
- журналирование изменений сущностей в базе данных;
- асинхронная обработка событий через очередь сообщений;
- отправка уведомлений по электронной почте при выполнении заданных условий.

---

## Используемые технологии
- Java 17
- Spring Data JPA
- Spring JMS
- ActiveMQ Classic
- H2 Database (in-memory)
- MailHog (SMTP-сервер для тестирования)
- Swagger (OpenAPI)

---

## Архитектура решения

При изменении данных в системе (создание, обновление, удаление сущностей)
приложение публикует сообщение в JMS-очередь.  
Дальнейшая обработка выполняется асинхронно с помощью слушателя сообщений.

### Основные компоненты:
- **ChangeEventPublisher** — публикует события изменений в JMS-тему
- **AuditLogListener** — подписчик темы, отвечает только за журналирование
- **MailNotificationListener** — подписчик темы, отвечает только за email-уведомления
- **AuditLog** — сущность для хранения журнала изменений
- **ActiveMQ** — брокер сообщений
- **MailHog** — приём и просмотр отправленных email

---

## Реализация заданий

### Задание 1  
Добавлена таблица `AUDIT_LOG`, в которой хранятся записи о каждом изменении:

- тип события (CREATE / UPDATE / DELETE);
- тип сущности;
- идентификатор сущности;
- описание изменений;
- время события.

Запись в журнал происходит автоматически при получении JMS-сообщения.

---

### Задание 2  
Настроен брокер сообщений **ActiveMQ Classic**.  
В приложении используется очередь:
library.changes


---

### Задание 3  
Приложение отправляет JMS-сообщения при следующих действиях:
- создание сущности;
- обновление сущности;
- удаление сущности.

Сообщение содержит объект `ChangeEvent`.

---

### Задание 4  
Реализован первый JMS-подписчик — AuditLogListener, который:
который:
- принимает сообщения из очереди;
- проверяет тип и структуру события;
- сохраняет информацию в таблицу `AUDIT_LOG`.

---

### Задание 5  
Реализован второй JMS-подписчик — MailNotificationListener, который:
- получает сообщения из той же JMS-темы;
- анализирует тип события;

---

### Задание 6  
При выполнении условия (DELETE):
- формируется email-сообщение;
- сообщение отправляется через SMTP-сервер MailHog.

---

### Задание 7  
Все компоненты системы успешно интегрированы и работают совместно:
- REST API;
- JMS;
- журналирование;
- email-уведомления.

---

## Конфигурация приложения

### JMS
```properties
app.jms.queue.changes=library.changes


Проверка работы
Swagger UI
http://localhost:8080/swagger-ui/index.html

H2 Console
http://localhost:8080/h2-console


JDBC URL:
jdbc:h2:mem:librarydb


Для просмотра журнала:
SELECT * FROM AUDIT_LOG;

MailHog
http://localhost:8025

